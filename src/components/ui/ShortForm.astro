<form
  id="newsletter-form"
  class="bg-[#292A32] px-10 py-14 rounded-[14px] gap-5 h-full flex flex-col sm:flex-row items-center justify-center"
>
  <div class="w-full sm:w-[55%]">
    <input
      type="email"
      id="newsletter-email"
      name="email"
      placeholder="your@email.com"
      required
      class="bg-transparent w-full px-[35px] py-5 border rounded-[14px] focus:outline-none text-white"
    />
  </div>
  <button type="submit" name="submit" class="w-full sm:w-[45%] btn-tertiary"
    >Subscribe to Insights</button
  >
</form>
<div id="newsletter-status" class="mt-4 text-center text-gray hidden"></div>

<script>
  async function newsletterSetup() {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const status = document.getElementById("newsletter-status") as HTMLDivElement;

    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const email = formData.get('email') as string;

        try {
          const { createClient } = await import('@supabase/supabase-js');
          const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
          const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
          const supabase = createClient(supabaseUrl, supabaseKey);

          const { error } = await supabase
            .from('newsletter_signups')
            .insert([{ email, source: 'footer' }]);

          if (error) {
            if (error.code === '23505') {
              status.textContent = 'You\'re already subscribed!';
            } else {
              throw error;
            }
          } else {
            status.textContent = 'Thanks for subscribing!';
          }

          status.classList.remove('hidden');
          form.reset();

          setTimeout(() => {
            status.classList.add('hidden');
          }, 5000);
        } catch (error) {
          console.error('Error:', error);
          status.textContent = 'Something went wrong. Please try again.';
          status.classList.remove('hidden');
        }
      });
    }
  }

  newsletterSetup();
  document.addEventListener("astro:after-swap", newsletterSetup);
</script>
