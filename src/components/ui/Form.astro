---
import { Image } from "astro:assets";
import decorForm from "../../assets/pics/contact-pic.png";
---

<div
  class="flex relative justify-start items-center p-[60px] bg-[#F3F3F3] rounded-[45px] overflow-hidden"
>
  <form id="contact-form" class="bg-gray sm:p-6 h-full w-full lg:max-w-lg">
    <div class="mb-4">
      <label for="name" class="block text-black mb-2">Name*</label>
      <input
        type="text"
        id="name"
        name="name"
        placeholder="Your name"
        required
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>

    <div class="mb-4">
      <label for="email" class="block text-black mb-2">Email*</label>
      <input
        type="email"
        id="email"
        name="email"
        placeholder="your@email.com"
        required
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>

    <div class="mb-4">
      <label for="company" class="block text-black mb-2">Company</label>
      <input
        type="text"
        id="company"
        name="company"
        placeholder="Your learntech company"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>

    <div class="mb-4">
      <label for="message" class="block text-black mb-2">Message*</label>
      <textarea
        id="message"
        name="message"
        placeholder="Tell us about your growth goals..."
        required
        rows="4"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      ></textarea>
    </div>

    <button type="submit" name="submit" class="btn-primary w-full">Send Message</button>
    <div id="form-status" class="mt-4 text-center hidden"></div>
  </form>
  <picture class="absolute right-[-25%] top-[2%] bottom-[2%] hidden lg:block">
    <Image src={decorForm} alt="decor" />
  </picture>
</div>
<script>
  async function formSetup() {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const status = document.getElementById("form-status") as HTMLDivElement;

    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const data = {
          name: formData.get('name') as string,
          email: formData.get('email') as string,
          company: formData.get('company') as string,
          message: formData.get('message') as string,
        };

        try {
          const { createClient } = await import('@supabase/supabase-js');
          const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
          const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
          const supabase = createClient(supabaseUrl, supabaseKey);

          const { error } = await supabase
            .from('contact_submissions')
            .insert([data]);

          if (error) throw error;

          status.textContent = 'Thank you! We\'ll be in touch soon.';
          status.className = 'mt-4 text-center text-green';
          status.classList.remove('hidden');
          form.reset();

          setTimeout(() => {
            status.classList.add('hidden');
          }, 5000);
        } catch (error) {
          console.error('Error:', error);
          status.textContent = 'Something went wrong. Please try again.';
          status.className = 'mt-4 text-center text-red-600';
          status.classList.remove('hidden');
        }
      });
    }
  }

  formSetup();
  document.addEventListener("astro:after-swap", formSetup);
</script>
